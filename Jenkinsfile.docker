# ===============================================
# Jenkinsfile - Build Docker optimis√© pour Java 21
# ===============================================

pipeline {
    agent any

    environment {
        // Configuration Registry
        REGISTRY = 'registry.dealtogether.ca'
        IMAGE_NAME = 'bffpaytogether'

        // Credentials Jenkins
        REGISTRY_CREDENTIALS = credentials('registry-credentials')

        // Docker BuildKit pour builds optimis√©s
        DOCKER_BUILDKIT = '1'

        // Version de l'image
        IMAGE_TAG = "${env.BRANCH_NAME == 'main' ? 'latest' : env.BRANCH_NAME}-${env.BUILD_NUMBER}"
    }

    options {
        // Garder seulement les 10 derniers builds
        buildDiscarder(logRotator(numToKeepStr: '10'))

        // Timeout du pipeline
        timeout(time: 30, unit: 'MINUTES')

        // Horodatage dans les logs
        timestamps()
    }

    stages {
        stage('üìã Pr√©paration') {
            steps {
                echo "üöÄ D√©marrage du build - ${IMAGE_NAME}:${IMAGE_TAG}"
                echo "Branche: ${env.BRANCH_NAME}"
                echo "Commit: ${env.GIT_COMMIT}"

                // Nettoyage de l'espace de travail
                cleanWs()

                // Checkout du code
                checkout scm
            }
        }

        stage('üîç Validation') {
            steps {
                script {
                    echo "V√©rification du Dockerfile..."

                    // V√©rifier que le Dockerfile existe
                    sh '''
                        if [ ! -f "modules/bff/Dockerfile" ]; then
                            echo "‚ùå Dockerfile introuvable"
                            exit 1
                        fi
                        echo "‚úÖ Dockerfile trouv√©"
                    '''

                    // V√©rifier que les fichiers POM existent
                    sh '''
                        for pom in pom.xml \
                            modules/bff/bff-core/pom.xml \
                            modules/bff/bff-provider/pom.xml \
                            modules/bff/bff-wsclient/pom.xml \
                            modules/bff/bff-api/pom.xml \
                            modules/bff/bff-configuration/pom.xml
                        do
                            if [ ! -f "$pom" ]; then
                                echo "‚ùå POM manquant: $pom"
                                exit 1
                            fi
                        done
                        echo "‚úÖ Tous les fichiers POM pr√©sents"
                    '''
                }
            }
        }

        stage('üî® Build Docker Image') {
            steps {
                script {
                    echo "Construction de l'image Docker avec BuildKit..."

                    sh """
                        docker build \
                            --file modules/bff/Dockerfile \
                            --tag ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --tag ${REGISTRY}/${IMAGE_NAME}:${env.BRANCH_NAME}-latest \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VCS_REF=\${GIT_COMMIT} \
                            --progress=plain \
                            .
                    """

                    echo "‚úÖ Image construite avec succ√®s"
                }
            }
        }

        stage('üîç Scan de s√©curit√©') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "Scan de s√©curit√© de l'image..."

                    // Utiliser Trivy pour scanner les vuln√©rabilit√©s
                    sh """
                        docker run --rm \
                            -v /var/run/docker.sock:/var/run/docker.sock \
                            aquasec/trivy:latest image \
                            --severity HIGH,CRITICAL \
                            --exit-code 0 \
                            ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                    """

                    echo "‚úÖ Scan de s√©curit√© termin√©"
                }
            }
        }

        stage('üìä Informations Image') {
            steps {
                script {
                    echo "Informations sur l'image construite:"

                    sh """
                        echo "==================================="
                        echo "Taille de l'image:"
                        docker images ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}"
                        echo ""
                        echo "Layers (10 premiers):"
                        docker history ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} --format "table {{.CreatedBy}}\\t{{.Size}}" | head -11
                        echo "==================================="
                    """
                }
            }
        }

        stage('üß™ Tests Image') {
            steps {
                script {
                    echo "Test de d√©marrage de l'image..."

                    // D√©marrer un container temporaire
                    sh """
                        # D√©marrer le container
                        docker run -d \
                            --name bff-test-${BUILD_NUMBER} \
                            -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=test \
                            ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}

                        # Attendre le d√©marrage (max 120 secondes)
                        echo "Attente du d√©marrage de l'application..."
                        for i in {1..24}; do
                            if docker exec bff-test-${BUILD_NUMBER} wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health 2>&1 | grep -q '200 OK'; then
                                echo "‚úÖ Application d√©marr√©e avec succ√®s"
                                exit 0
                            fi
                            echo "Tentative \$i/24..."
                            sleep 5
                        done

                        echo "‚ùå L'application n'a pas d√©marr√© dans les temps"
                        docker logs bff-test-${BUILD_NUMBER}
                        exit 1
                    """
                }
            }
            post {
                always {
                    // Toujours nettoyer le container de test
                    sh """
                        docker stop bff-test-${BUILD_NUMBER} || true
                        docker rm bff-test-${BUILD_NUMBER} || true
                    """
                }
            }
        }

        stage('üì§ Push vers Registry') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    echo "Push de l'image vers le registry..."

                    sh """
                        # Login au registry
                        echo \${REGISTRY_CREDENTIALS_PSW} | docker login ${REGISTRY} -u \${REGISTRY_CREDENTIALS_USR} --password-stdin

                        # Push de l'image avec les tags
                        docker push ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                        docker push ${REGISTRY}/${IMAGE_NAME}:${env.BRANCH_NAME}-latest

                        # Si branche main, push √©galement le tag 'latest'
                        if [ "${env.BRANCH_NAME}" = "main" ]; then
                            docker tag ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY}/${IMAGE_NAME}:latest
                            docker push ${REGISTRY}/${IMAGE_NAME}:latest
                        fi

                        # Logout
                        docker logout ${REGISTRY}
                    """

                    echo "‚úÖ Image push√©e avec succ√®s vers ${REGISTRY}"
                }
            }
        }

        stage('üöÄ D√©ploiement DEV') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    echo "D√©ploiement en environnement DEV..."

                    sh """
                        # Mise √† jour du d√©ploiement Kubernetes
                        kubectl set image deployment/bff-deployment \
                            bff=${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --namespace=paytogether-dev

                        # Attendre le rollout
                        kubectl rollout status deployment/bff-deployment \
                            --namespace=paytogether-dev \
                            --timeout=5m
                    """

                    echo "‚úÖ D√©ploiement DEV r√©ussi"
                }
            }
        }

        stage('üöÄ D√©ploiement PROD') {
            when {
                branch 'main'
            }
            steps {
                script {
                    // Demander confirmation avant d√©ploiement en production
                    input message: 'D√©ployer en PRODUCTION ?', ok: 'D√©ployer'

                    echo "D√©ploiement en environnement PRODUCTION..."

                    sh """
                        # Mise √† jour du d√©ploiement Kubernetes
                        kubectl set image deployment/bff-deployment-prod \
                            bff=${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --namespace=paytogether-prod

                        # Attendre le rollout
                        kubectl rollout status deployment/bff-deployment-prod \
                            --namespace=paytogether-prod \
                            --timeout=5m
                    """

                    echo "‚úÖ D√©ploiement PROD r√©ussi"
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Nettoyage..."

            // Nettoyer les images locales pour lib√©rer de l'espace
            sh """
                docker image prune -f --filter "label=description=BFF PayToGether - Java 21" || true
            """
        }

        success {
            echo "‚úÖ Pipeline termin√© avec succ√®s !"

            // Notifications (Slack, email, etc.)
            // slackSend color: 'good', message: "Build r√©ussi: ${IMAGE_NAME}:${IMAGE_TAG}"
        }

        failure {
            echo "‚ùå Pipeline √©chou√©"

            // Notifications en cas d'√©chec
            // slackSend color: 'danger', message: "Build √©chou√©: ${IMAGE_NAME}:${IMAGE_TAG}"
        }
    }
}

